generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}
 
model User {
  id          String    @id @default(cuid())
  uid         String    @unique @default(uuid())
  name        String
  email       String    @unique
  phone       String?
  password    String
  role        String    @default("USER")
  status      String    @default("ACTIVE")
  dateOfBirth DateTime?
  gender      String?
  createdAt   DateTime  @default(now())
  tickets     Ticket[]
  reviews     Review[]
}

model Cinema {
  id        String @id @default(cuid())
  name      String
  region    String
  address   String
  latitude  Float?
  longitude Float?
  logoUrl   String?
  phone     String?
  screenings Screening[]
}

enum MovieStatus {
  COMING_SOON
  NOW_PLAYING
  ARCHIVED
}

model Movie {
  id           String      @id @default(cuid())
  title        String
  slug         String?     @unique
  actors       String?
  director     String?
  duration     Int
  genres       String?
  countries    String?
  releaseDate  DateTime?
  rating       Float?
  ageRating    String?     // T13, T16, T18, etc.
  description  String?
  summary      String?
  posterUrl    String?
  backdropUrl  String?
  trailerUrl   String?
  formats      String?     // JSON array: ["2D", "3D", "IMAX"]
  cast         String?     // JSON array of cast members
  status       MovieStatus @default(COMING_SOON)
  isPreSale    Boolean     @default(false)
  isFeatured   Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  screenings   Screening[]
  
  @@index([status])
  @@index([releaseDate])
  @@index([isFeatured])
}

model Screening {
  id        String   @id @default(cuid())
  movieId   String
  cinemaId  String
  room      String
  startTime DateTime
  endTime   DateTime
  price     Int
  movie     Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  cinema    Cinema   @relation(fields: [cinemaId], references: [id], onDelete: Cascade)
  seats     Seat[]
  seatStatuses SeatStatus[]
  orders    Order[]
  tickets   Ticket[]
  
  @@index([movieId])
  @@index([cinemaId])
  @@index([startTime])
}

model Review {
  id        String   @id @default(cuid())
  movieId   String
  userId    String
  rating    Int
  content   String?
  tags      String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum SeatState {
  AVAILABLE
  HELD
  SOLD
}

model Seat {
  id          String    @id @default(cuid())
  screeningId String
  row         Int
  col         Int
  code        String    // "A1", "D6", ...
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  screening   Screening @relation(fields: [screeningId], references: [id], onDelete: Cascade)
  statuses    SeatStatus[]

  @@unique([screeningId, row, col])
  @@index([screeningId])
}

model SeatStatus {
  id          String    @id @default(cuid())
  seatId      String
  screeningId String
  status      SeatState @default(AVAILABLE)
  holdToken   String?
  holdUserId  String?
  holdUntil   DateTime?
  orderId     String?
  createdAt   DateTime  @default(now())
  seat        Seat      @relation(fields: [seatId], references: [id], onDelete: Cascade)
  screening   Screening @relation(fields: [screeningId], references: [id], onDelete: Cascade)
  order       Order?    @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  @@index([screeningId, seatId])
  @@index([screeningId, status])
  @@index([holdToken])
  @@index([seatId, createdAt])
}

model Order {
  id              String    @id @default(cuid())
  userId          String
  screeningId     String
  holdToken       String    @unique
  status          String    @default("PENDING")
  seatIds         String
  pricingBreakdown String?
  totalAmount     Int
  voucherCode     String?
  idempotencyKey  String?   @unique
  qrCode          String?   @unique
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  screening       Screening @relation(fields: [screeningId], references: [id], onDelete: Cascade)
  seatStatuses    SeatStatus[]
  payments        Payment[]
  tickets         Ticket[]

  @@index([userId])
  @@index([holdToken])
  @@index([status, expiresAt])
  @@index([qrCode])
}

model Ticket {
  id         String    @id @default(cuid())
  code       String    @unique @default(uuid())
  orderId    String
  screeningId String
  seatId     String
  seatRow    Int
  seatCol    Int
  userId     String
  status     String    @default("PENDING")
  price      Int
  qrCode     String?
  checkInAt  DateTime?
  createdAt  DateTime  @default(now())
  order      Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  screening  Screening? @relation(fields: [screeningId], references: [id], onDelete: Cascade)
}

model Payment {
  id               String   @id @default(cuid())
  orderId          String
  userId           String?
  gateway          String   @default("mock") // 'mock', 'momo', 'vnpay', ...
  method           String?   // 'qrcode', 'app', 'card', ...
  amount           Int
  fee              Int      @default(0)
  net              Int      @default(0) // New field, can be calculated from amount - fee
  netAmount        Int?     // Keep old field for backward compatibility
  currency         String   @default("VND")
  status           String   // 'PENDING'|'SUCCESS'|'FAILED'|'CANCELED'|'REFUNDED'|'PARTIAL_REFUNDED'
  providerTxId     String?  // transaction id từ cổng
  providerOrderId  String?  // order ref ở provider
  externalRef      String?  // Keep old field for backward compatibility
  rawPayload       String?  // JSON string (payload đã mask)
  webhookData      String?  // Keep old field for backward compatibility
  redirectUrl      String?  // Keep old field for backward compatibility
  source           String?  // Keep old field for backward compatibility
  errorCode        String?
  errorMessage     String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  order            Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  refunds          Refund[]

  @@index([orderId])
  @@index([gateway, status])
  @@index([createdAt])
  @@index([providerTxId])
  @@index([status])
  @@index([method])
  @@index([source])
}

model WebhookEvent {
  id           String   @id @default(cuid())
  paymentId    String?
  gateway      String
  eventType    String
  receivedAt   DateTime @default(now())
  rawPayload   String   // JSON string
  signature    String?
  verified     Boolean  @default(false)
  handled      Boolean  @default(false)
  idempotencyKey String @unique // để chống xử lý lặp

  @@index([gateway])
  @@index([receivedAt])
  @@index([idempotencyKey])
}

model Refund {
  id            String   @id @default(cuid())
  paymentId     String
  amount        Int
  reason        String?
  status        String   // 'PENDING'|'SUCCESS'|'FAILED'
  providerRefundId String?
  idempotencyKey String? @unique
  createdAt     DateTime @default(now())
  payment       Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@index([idempotencyKey])
}

model PaymentGateway {
  code        String  @id   // 'mock','momo','vnpay'
  name        String
  enabled     Boolean @default(true)
  locked      Boolean @default(false) // khóa tạm khi lỗi
  configJson  String? // JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum EventStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model Event {
  id          String      @id @default(cuid())
  title       String
  slug        String?     @unique
  description String?
  content     String?     // Rich text content
  imageUrl    String?     // Main banner image
  thumbnailUrl String?    // Thumbnail for list view
  startDate   DateTime?
  endDate     DateTime?
  status      EventStatus @default(ACTIVE)
  isFeatured  Boolean     @default(false)
  viewCount   Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([status])
  @@index([isFeatured])
  @@index([startDate])
  @@index([endDate])
}

model Banner {
  id          String    @id @default(cuid())
  title       String?   // Tên banner (optional)
  imageUrl    String    // URL ảnh banner (required)
  linkUrl     String?   // Link khi click (optional - có thể link đến /movie/:slug hoặc /event/:slug)
  linkType    String?   // 'movie', 'event', 'external', null
  order       Int       @default(0) // Thứ tự hiển thị
  isActive    Boolean   @default(true)
  startDate   DateTime? // Ngày bắt đầu hiển thị
  endDate     DateTime? // Ngày kết thúc hiển thị
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
  @@index([order])
  @@index([startDate])
  @@index([endDate])
}
